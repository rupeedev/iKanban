/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

import{$getNodeByKey as e,$isLineBreakNode as t,$isTextNode as n,$getSelection as o,$isRangeSelection as s,createEditor as l,$isElementNode as i,$isDecoratorNode as r,$isRootNode as c,$getWritableNodeState as a,$getRoot as f,$getNodeByKeyOrThrow as u,removeFromParent as d,$addUpdateTag as h,SKIP_SCROLL_INTO_VIEW_TAG as _,HISTORIC_TAG as p,COLLABORATION_TAG as g,$createParagraphNode as y,createCommand as x}from"lexical";import{XmlText as m,Map as k,XmlElement as b,Doc as C,createAbsolutePositionFromRelativePosition as N,createRelativePositionFromTypeIndex as v,compareRelativePositions as w,YMapEvent as S,YTextEvent as T,YXmlEvent as P,UndoManager as F}from"yjs";import{$createChildrenArray as O}from"@lexical/offset";import{createDOMRange as E,createRectsFromDOMRange as M}from"@lexical/selection";function L(e,...t){const n=new URL("https://lexical.dev/docs/error"),o=new URLSearchParams;o.append("code",e);for(const e of t)o.append("v",e);throw n.search=o.toString(),Error(`Minified Lexical error #${e}; visit ${n.toString()} for the full message or use the non-minified dev environment for full errors and additional helpful warnings.`)}class z{_map;_key;_parent;_type;constructor(e,t){this._key="",this._map=e,this._parent=t,this._type="linebreak"}getNode(){const n=e(this._key);return t(n)?n:null}getKey(){return this._key}getSharedType(){return this._map}getType(){return this._type}getSize(){return 1}getOffset(){return this._parent.getChildOffset(this)}destroy(e){const t=e.collabNodeMap;t.get(this._key)===this&&t.delete(this._key)}}function j(e,t){const n=new z(e,t);return e._collabNode=n,n}class A{_map;_key;_parent;_text;_type;_normalized;constructor(e,t,n,o){this._key="",this._map=e,this._parent=n,this._text=t,this._type=o,this._normalized=!1}getPrevNode(e){if(null===e)return null;const t=e.get(this._key);return n(t)?t:null}getNode(){const t=e(this._key);return n(t)?t:null}getSharedType(){return this._map}getType(){return this._type}getKey(){return this._key}getSize(){return this._text.length+(this._normalized?0:1)}getOffset(){return this._parent.getChildOffset(this)}spliceText(e,t,n){const o=this._parent._xmlText,s=this.getOffset()+1+e;0!==t&&o.delete(s,t),""!==n&&o.insert(s,n)}syncPropertiesAndTextFromLexical(e,t,n){const l=this.getPrevNode(n),i=t.__text;if(V(e,this._map,l,t),null!==l){const e=l.__text;if(e!==i){!function(e,t,n,l){const i=o();let r=l.length;if(s(i)&&i.isCollapsed()){const e=i.anchor;e.key===t&&(r=e.offset)}const c=function(e,t,n){const o=e.length,s=t.length;let l=0,i=0;for(;l<o&&l<s&&e[l]===t[l]&&l<n;)l++;for(;i+l<o&&i+l<s&&e[o-i-1]===t[s-i-1];)i++;for(;i+l<o&&i+l<s&&e[l]===t[l];)l++;return{index:l,insert:t.slice(l,s-i),remove:o-l-i}}(n,l,r);e.spliceText(c.index,c.remove,c.insert)}(this,t.__key,e,i),this._text=i}}}syncPropertiesAndTextFromYjs(e,t){const n=this.getNode();null===n&&L(84),J(e,this._map,n,t);const o=this._text;n.__text!==o&&n.setTextContent(o)}destroy(e){const t=e.collabNodeMap;t.get(this._key)===this&&t.delete(this._key)}}function Y(e,t,n,o){const s=new A(e,t,n,o);return e._collabNode=s,s}const D=new Set(["__key","__parent","__next","__prev","__state"]),I=new Set(["__first","__last","__size"]),K=new Set(["__cachedText"]),$=new Set(["__text"]);function W(e,t,o){if(D.has(e)||"function"==typeof t[e])return!0;if(n(t)){if($.has(e))return!0}else if(i(t)&&(I.has(e)||c(t)&&K.has(e)))return!0;const s=t.constructor,l=o.excludedProperties.get(s);return null!=l&&l.has(e)}function R(e,o,s){const l=o.__type;let c;if(i(o)){c=le(new m,s,l),c.syncPropertiesFromLexical(e,o,null),c.syncChildrenFromLexical(e,o,null,null,null)}else if(n(o)){c=Y(new k,o.__text,s,l),c.syncPropertiesAndTextFromLexical(e,o,null)}else if(t(o)){const e=new k;e.set("__type","linebreak"),c=j(e,s)}else if(r(o)){c=oe(new b,s,l),c.syncPropertiesFromLexical(e,o,null)}else L(86);return c._key=o.__key,c}function U(e){const t=q(e,"__type");return"string"!=typeof t&&void 0!==t&&L(87),t}function B(e,t,n){const o=t._collabNode;if(void 0===o){const o=e.editor._nodes,s=U(t);"string"!=typeof s&&L(87);void 0===o.get(s)&&L(88,s);const l=t.parent,i=void 0===n&&null!==l?B(e,l):n||null;if(i instanceof se||L(89),t instanceof m)return le(t,i,s);if(t instanceof k)return"linebreak"===s?j(t,i):Y(t,"",i,s);if(t instanceof b)return oe(t,i,s)}return o}function G(e,t,n){const o=t.getType(),s=e.editor._nodes.get(o);void 0===s&&L(88,o);const l=new s.klass;if(l.__parent=n,t._key=l.__key,t instanceof se){const n=t._xmlText;t.syncPropertiesFromYjs(e,null),t.applyChildrenYjsDelta(e,n.toDelta()),t.syncChildrenFromYjs(e)}else t instanceof A?t.syncPropertiesAndTextFromYjs(e,null):t instanceof ne&&t.syncPropertiesFromYjs(e,null);return e.collabNodeMap.set(l.__key,t),l}function J(e,t,n,o){const s=null===o?t instanceof k?Array.from(t.keys()):Object.keys(t.getAttributes()):Array.from(o);let i;for(let o=0;o<s.length;o++){const r=s[o];if(W(r,n,e)){"__state"===r&&(i||(i=n.getWritable()),Q(e,t,i));continue}const c=n[r];let a=q(t,r);if(c!==a){if(a instanceof C){const t=e.docMap;c instanceof C&&t.delete(c.guid);const n=l(),o=a.guid;n._key=o,t.set(o,a),a=n}void 0===i&&(i=n.getWritable()),i[r]=a}}}function q(e,t){return e instanceof k?e.get(t):e.getAttribute(t)}function H(e,t,n){e instanceof k?e.set(t,n):e.setAttribute(t,n)}function Q(e,t,n){const o=q(t,"__state");o instanceof k&&a(n).updateFromJSON(o.toJSON())}function V(e,t,n,o){const s=o.__type,l=e.nodeProperties;let i=l.get(s);void 0===i&&(i=Object.keys(o).filter(t=>!W(t,o,e)),l.set(s,i));const r=e.editor.constructor;!function(e,t,n,o){const s=o.__state,l=q(t,"__state");if(!s)return;const[i,r]=s.getInternalState(),c=n&&n.__state,a=l instanceof k?l:new k;if(c===s)return;const[f,u]=c&&a.doc?c.getInternalState():[void 0,new Map];if(i)for(const[e,t]of Object.entries(i))f&&t!==f[e]&&a.set(e,t);for(const[e,t]of r)u.get(e)!==t&&a.set(e.key,e.unparse(t));l||H(t,"__state",a)}(0,t,n,o);for(let s=0;s<i.length;s++){const l=i[s],c=null===n?void 0:n[l];let a=o[l];if(c!==a){if(a instanceof r){const t=e.docMap;let n;if(c instanceof r){const e=c._key;n=t.get(e),t.delete(e)}const s=n||new C,l=s.guid;a._key=l,t.set(l,s),a=s,e.editor.update(()=>{o.markDirty()})}H(t,l,a)}}}function X(e,t,n,o){return e.slice(0,t)+o+e.slice(t+n)}function Z(e,t,n){let o=0,s=0;const l=e._children,i=l.length;for(;s<i;s++){const e=l[s],r=o;o+=e.getSize();if((n?o>=t:o>t)&&e instanceof A){let n=t-r-1;n<0&&(n=0);return{length:o-t,node:e,nodeIndex:s,offset:n}}if(o>t)return{length:0,node:e,nodeIndex:s,offset:r};if(s===i-1)return{length:0,node:null,nodeIndex:s+1,offset:r+1}}return{length:0,node:null,nodeIndex:0,offset:0}}function ee(e){const t=e.anchor,o=e.focus;let s=!1;try{const e=t.getNode(),l=o.getNode();(!e.isAttached()||!l.isAttached()||n(e)&&t.offset>e.getTextContentSize()||n(l)&&o.offset>l.getTextContentSize())&&(s=!0)}catch(e){s=!0}return s}function te(t,n){const o=n._nodeMap.get(t);if(!o)return void f().selectStart();const s=o.__prev;let l=null;s&&(l=e(s)),null===l&&null!==o.__parent&&(l=e(o.__parent)),null!==l?null!==l&&l.isAttached()?l.selectEnd():te(l.__key,n):f().selectStart()}class ne{_xmlElem;_key;_parent;_type;constructor(e,t,n){this._key="",this._xmlElem=e,this._parent=t,this._type=n}getPrevNode(e){if(null===e)return null;const t=e.get(this._key);return r(t)?t:null}getNode(){const t=e(this._key);return r(t)?t:null}getSharedType(){return this._xmlElem}getType(){return this._type}getKey(){return this._key}getSize(){return 1}getOffset(){return this._parent.getChildOffset(this)}syncPropertiesFromLexical(e,t,n){const o=this.getPrevNode(n);V(e,this._xmlElem,o,t)}syncPropertiesFromYjs(e,t){const n=this.getNode();null===n&&L(83);J(e,this._xmlElem,n,t)}destroy(e){const t=e.collabNodeMap;t.get(this._key)===this&&t.delete(this._key)}}function oe(e,t,n){const o=new ne(e,t,n);return e._collabNode=o,o}class se{_key;_children;_xmlText;_type;_parent;constructor(e,t,n){this._key="",this._children=[],this._xmlText=e,this._type=n,this._parent=t}getPrevNode(e){if(null===e)return null;const t=e.get(this._key);return i(t)?t:null}getNode(){const t=e(this._key);return i(t)?t:null}getSharedType(){return this._xmlText}getType(){return this._type}getKey(){return this._key}isEmpty(){return 0===this._children.length}getSize(){return 1}getOffset(){const e=this._parent;return null===e&&L(90),e.getChildOffset(this)}syncPropertiesFromYjs(e,t){const n=this.getNode();null===n&&L(91),J(e,this._xmlText,n,t)}applyChildrenYjsDelta(e,t){const n=this._children;let o=0,s=null;for(let l=0;l<t.length;l++){const i=t[l],r=i.insert,c=i.delete;if(null!=i.retain)o+=i.retain;else if("number"==typeof c){let e=c;for(;e>0;){const{node:t,nodeIndex:s,offset:l,length:i}=Z(this,o,!1);if(t instanceof se||t instanceof z||t instanceof ne)n.splice(s,1),e-=1;else{if(!(t instanceof A))break;{const o=Math.min(e,i),r=0!==s?n[s-1]:null,c=t.getSize();if(0===l&&i===c){n.splice(s,1);const e=X(t._text,l,o-1,"");e.length>0&&(r instanceof A?r._text+=e:this._xmlText.delete(l,e.length))}else t._text=X(t._text,l,o,"");e-=o}}}}else{if(null==r)throw new Error("Unexpected delta format");if("string"==typeof r){const{node:e,offset:t}=Z(this,o,!0);e instanceof A?e._text=X(e._text,t,0,r):this._xmlText.delete(t,r.length),o+=r.length}else{const t=r,{node:l,nodeIndex:i,length:c}=Z(this,o,!1),a=B(e,t,this);if(l instanceof A&&c>0&&c<l._text.length){const e=l._text,t=e.length-c;l._text=X(e,t,c,""),n.splice(i+1,0,a),s=X(e,0,t,"")}else n.splice(i,0,a);null!==s&&a instanceof A&&(a._text=s+a._text,s=null),o+=1}}}}syncChildrenFromYjs(e){const t=this.getNode();null===t&&L(92);const o=t.__key,s=O(t,null),l=s.length,i=this._children,r=i.length,c=e.collabNodeMap,a=new Set;let f,h,_=0,p=null;r!==l&&(h=t.getWritable());for(let l=0;l<r;l++){const g=s[_],y=i[l],x=y.getNode(),m=y._key;if(null!==x&&g===m){const t=n(x);if(a.add(g),t)if(y._key=g,y instanceof se){const t=y._xmlText;y.syncPropertiesFromYjs(e,null),y.applyChildrenYjsDelta(e,t.toDelta()),y.syncChildrenFromYjs(e)}else y instanceof A?y.syncPropertiesAndTextFromYjs(e,null):y instanceof ne?y.syncPropertiesFromYjs(e,null):y instanceof z||L(93);p=x,_++}else{if(void 0===f){f=new Set;for(let e=0;e<r;e++){const t=i[e]._key;""!==t&&f.add(t)}}if(null!==x&&void 0!==g&&!f.has(g)){const e=u(g);d(e),l--,_++;continue}h=t.getWritable();const n=G(e,y,o),s=n.__key;if(c.set(s,y),null===p){const e=h.getFirstChild();if(h.__first=s,null!==e){const t=e.getWritable();t.__prev=s,n.__next=t.__key}}else{const e=p.getWritable(),t=p.getNextSibling();if(e.__next=s,n.__prev=p.__key,null!==t){const e=t.getWritable();e.__prev=s,n.__next=e.__key}}l===r-1&&(h.__last=s),h.__size++,p=n}}for(let t=0;t<l;t++){const n=s[t];if(!a.has(n)){const t=u(n),o=e.collabNodeMap.get(n);void 0!==o&&o.destroy(e),d(t)}}}syncPropertiesFromLexical(e,t,n){V(e,this._xmlText,this.getPrevNode(n),t)}_syncChildFromLexical(e,t,o,s,l,c){const a=this._children[t],f=u(o);a instanceof se&&i(f)?(a.syncPropertiesFromLexical(e,f,s),a.syncChildrenFromLexical(e,f,s,l,c)):a instanceof A&&n(f)?a.syncPropertiesAndTextFromLexical(e,f,s):a instanceof ne&&r(f)&&a.syncPropertiesFromLexical(e,f,s)}syncChildrenFromLexical(e,t,n,o,s){const l=this.getPrevNode(n),i=null===l?[]:O(l,n),r=O(t,null),c=i.length-1,a=r.length-1,f=e.collabNodeMap;let d,h,_=0,p=0;for(;_<=c&&p<=a;){const t=i[_],l=r[p];if(t===l)this._syncChildFromLexical(e,p,l,n,o,s),_++,p++;else{void 0===d&&(d=new Set(i)),void 0===h&&(h=new Set(r));const n=h.has(t),o=d.has(l);if(n){const t=R(e,u(l),this);f.set(l,t),o?(this.splice(e,p,1,t),_++,p++):(this.splice(e,p,0,t),p++)}else this.splice(e,p,1),_++}}const g=_>c,y=p>a;if(g&&!y)for(;p<=a;++p){const t=r[p],n=R(e,u(t),this);this.append(n),f.set(t,n)}else if(y&&!g)for(let t=this._children.length-1;t>=p;t--)this.splice(e,t,1)}append(e){const t=this._xmlText,n=this._children,o=n[n.length-1],s=void 0!==o?o.getOffset()+o.getSize():0;if(e instanceof se)t.insertEmbed(s,e._xmlText);else if(e instanceof A){const n=e._map;null===n.parent&&t.insertEmbed(s,n),t.insert(s+1,e._text)}else e instanceof z?t.insertEmbed(s,e._map):e instanceof ne&&t.insertEmbed(s,e._xmlElem);this._children.push(e)}splice(e,t,n,o){const s=this._children,l=s[t];if(void 0===l)return void 0===o&&L(94),void this.append(o);const i=l.getOffset();-1===i&&L(95);const r=this._xmlText;if(0!==n&&r.delete(i,l.getSize()),o instanceof se)r.insertEmbed(i,o._xmlText);else if(o instanceof A){const e=o._map;null===e.parent&&r.insertEmbed(i,e),r.insert(i+1,o._text)}else o instanceof z?r.insertEmbed(i,o._map):o instanceof ne&&r.insertEmbed(i,o._xmlElem);if(0!==n){const o=s.slice(t,t+n);for(let t=0;t<o.length;t++)o[t].destroy(e)}void 0!==o?s.splice(t,n,o):s.splice(t,n)}getChildOffset(e){let t=0;const n=this._children;for(let o=0;o<n.length;o++){const s=n[o];if(s===e)return t;t+=s.getSize()}return-1}destroy(e){const t=e.collabNodeMap,n=this._children;for(let t=0;t<n.length;t++)n[t].destroy(e);t.get(this._key)===this&&t.delete(this._key)}}function le(e,t,n){const o=new se(e,t,n);return e._collabNode=o,o}function ie(e,t,n,o,s,l){null==o&&L(81);const i=le(o.get("root",m),null,"root");return i._key="root",{clientID:o.clientID,collabNodeMap:new Map,cursors:new Map,cursorsContainer:null,doc:o,docMap:s,editor:e,excludedProperties:l||new Map,id:n,nodeProperties:new Map,root:i}}function re(e,t){const o=t.collabNodeMap.get(e.key);if(void 0===o)return null;let s=e.offset,l=o.getSharedType();if(o instanceof A){l=o._parent._xmlText;const e=o.getOffset();if(-1===e)return null;s=e+1+s}else if(o instanceof se&&"element"===e.type){const t=e.getNode();i(t)||L(184);let o=0,l=0,r=t.getFirstChild();for(;null!==r&&l++<s;)n(r)?o+=r.getTextContentSize()+1:o++,r=r.getNextSibling();s=o}return v(l,s)}function ce(e,t){return N(e,t.doc)}function ae(e,t){if(null==e){if(null!=t)return!0}else if(null==t||!w(e,t))return!0;return!1}function fe(e,t){return{color:t,name:e,selection:null}}function ue(e,t){const n=e.cursorsContainer;if(null!==n){const e=t.selections,o=e.length;for(let t=0;t<o;t++)n.removeChild(e[t])}}function de(e,t){const n=t.selection;null!==n&&ue(e,n)}function he(e,t,n,o,s){const l=e.color,i=document.createElement("span");i.style.cssText=`position:absolute;top:0;bottom:0;right:-1px;width:1px;background-color:${l};z-index:10;`;const r=document.createElement("span");return r.textContent=e.name,r.style.cssText=`position:absolute;left:-2px;top:-16px;background-color:${l};color:#fff;line-height:12px;font-size:12px;padding:2px;font-family:Arial;font-weight:bold;white-space:nowrap;`,i.appendChild(r),{anchor:{key:t,offset:n},caret:i,color:l,focus:{key:o,offset:s},name:r,selections:[]}}function _e(e,n,o,s){const l=e.editor,i=l.getRootElement(),r=e.cursorsContainer;if(null===r||null===i)return;const c=r.offsetParent;if(null===c)return;const a=c.getBoundingClientRect(),f=n.selection;if(null===o)return null===f?void 0:(n.selection=null,void ue(e,f));n.selection=o;const u=o.caret,d=o.color,h=o.selections,_=o.anchor,p=o.focus,g=_.key,y=p.key,x=s.get(g),m=s.get(y);if(null==x||null==m)return;let k;if(x===m&&t(x)){k=[l.getElementByKey(g).getBoundingClientRect()]}else{const e=E(l,x,_.offset,m,p.offset);if(null===e)return;k=M(l,e)}const b=h.length,C=k.length;for(let e=0;e<C;e++){const t=k[e];let n=h[e];if(void 0===n){n=document.createElement("span"),h[e]=n;const t=document.createElement("span");n.appendChild(t),r.appendChild(n)}const o=`position:absolute;top:${t.top-a.top}px;left:${t.left-a.left}px;height:${t.height}px;width:${t.width}px;pointer-events:none;z-index:5;`;n.style.cssText=o,n.firstChild.style.cssText=`${o}left:0;top:0;background-color:${d};opacity:0.3;`,e===C-1&&u.parentNode!==n&&n.appendChild(u)}for(let e=b-1;e>=C;e--){const t=h[e];r.removeChild(t),h.pop()}}function pe(e,t){const{anchorPos:n,focusPos:o}=t;let s=null,l=0,i=null,r=0;if(null!==n&&null!==o){const t=ce(n,e),c=ce(o,e);null!==t&&null!==c&&([s,l]=xe(t.type,t.index),[i,r]=xe(c.type,c.index))}return{anchorCollabNode:s,anchorOffset:l,focusCollabNode:i,focusOffset:r}}function ge(e,t){const n=t.awareness.getLocalState();if(null===n)return;const{anchorCollabNode:l,anchorOffset:i,focusCollabNode:r,focusOffset:c}=pe(e,n);if(null!==l&&null!==r){const e=l.getKey(),t=r.getKey(),n=o();if(!s(n))return;ye(n.anchor,e,i),ye(n.focus,t,c)}}function ye(t,o,s){if(t.key!==o||t.offset!==s){let l=e(o);if(null!==l&&!i(l)&&!n(l)){const e=l.getParentOrThrow();o=e.getKey(),s=l.getIndexWithinParent(),l=e}t.set(o,s,i(l)?"element":"text")}}function xe(e,t){const n=e._collabNode;if(void 0===n)return[null,0];if(n instanceof se){const{node:e,offset:o}=Z(n,t,!0);return null===e?[n,0]:[e,o]}return[null,0]}function me(e,t){return t.awareness.getStates()}function ke(e,t,n){const{getAwarenessStates:o=me}=n??{},s=Array.from(o(e,t)),l=e.clientID,i=e.cursors,r=e.editor._editorState._nodeMap,c=new Set;for(let t=0;t<s.length;t++){const n=s[t],[o,a]=n;if(o!==l){c.add(o);const{name:t,color:n,focusing:s}=a;let l=null,f=i.get(o);if(void 0===f&&(f=fe(t,n),i.set(o,f)),s){const{anchorCollabNode:t,anchorOffset:n,focusCollabNode:o,focusOffset:s}=pe(e,a);if(null!==t&&null!==o){const e=t.getKey(),i=o.getKey();if(l=f.selection,null===l)l=he(f,e,n,i,s);else{const t=l.anchor,o=l.focus;t.key=e,t.offset=n,o.key=i,o.offset=s}}}_e(e,f,l,r)}}const a=Array.from(i.keys());for(let t=0;t<a.length;t++){const n=a[t];if(!c.has(n)){const t=i.get(n);void 0!==t&&(de(e,t),i.delete(n))}}}function be(e,t,n,o){const l=t.awareness,i=l.getLocalState();if(null===i)return;const{anchorPos:r,focusPos:c,name:a,color:f,focusing:u,awarenessData:d}=i;let h=null,_=null;(null!==o&&(null===r||o.is(n))||null!==n)&&(s(o)&&(h=re(o.anchor,e),_=re(o.focus,e)),(ae(r,h)||ae(c,_))&&l.setLocalState({...i,anchorPos:h,awarenessData:d,color:f,focusPos:_,focusing:u,name:a}))}function Ce(e,t){if(t instanceof S&&function(e,t){const{target:n}=t;if(!n._item||"__state"!==n._item.parentSub||void 0!==U(n)||!(n.parent instanceof m||n.parent instanceof b||n.parent instanceof k))return!1;const o=B(e,n.parent).getNode();if(o){const e=a(o.getWritable());for(const o of t.keysChanged)e.updateFromUnknown(o,n.get(o))}return!0}(e,t))return;const{target:n}=t,o=B(e,n);if(o instanceof se&&t instanceof T){const{keysChanged:n,childListChanged:s,delta:l}=t;n.size>0&&o.syncPropertiesFromYjs(e,n),s&&(o.applyChildrenYjsDelta(e,l),o.syncChildrenFromYjs(e))}else if(o instanceof A&&t instanceof S){const{keysChanged:n}=t;n.size>0&&o.syncPropertiesAndTextFromYjs(e,n)}else if(o instanceof ne&&t instanceof P){const{attributesChanged:n}=t;n.size>0&&o.syncPropertiesFromYjs(e,n)}else L(82)}function Ne(e,t,n,l,i=ke){const r=e.editor,c=r._editorState;n.forEach(e=>e.delta),r.update(()=>{for(let t=0;t<n.length;t++){const o=n[t];Ce(e,o)}const i=o();if(s(i))if(ee(i)){const n=c._selection;if(s(n)&&(ge(e,t),ee(i))){te(i.anchor.key,c)}be(e,t,n,o())}else ge(e,t);l||h(_)},{onUpdate:()=>{i(e,t),r.update(()=>{0===f().getChildrenSize()&&f().append(y())})},skipTransforms:!0,tag:l?p:g})}function ve(t,s,l,i,r,c,a,u){!function(e,t){e.doc.transact(t,e)}(t,()=>{i.read(()=>{if(u.has(g)||u.has(p))return void(a.size>0&&function(t,o){const s=Array.from(o),l=t.collabNodeMap,i=[],r=[];for(let t=0;t<s.length;t++){const o=s[t],c=e(o),a=l.get(o);if(a instanceof A)if(n(c))i.push([a,c.__text]);else{const e=a.getOffset();if(-1===e)continue;const t=a._parent;a._normalized=!0,t._xmlText.delete(e,1),r.push(a)}}for(let e=0;e<r.length;e++){const t=r[e],n=t.getKey();l.delete(n);const o=t._parent._children,s=o.indexOf(t);o.splice(s,1)}for(let e=0;e<i.length;e++){const[t,n]=i[e];t._text=n}}(t,a));if(r.has("root")){const e=l._nodeMap,n=f(),o=t.root;o.syncPropertiesFromLexical(t,n,e),o.syncChildrenFromLexical(t,n,e,r,c)}const i=o(),d=l._selection;be(t,s,d,i)})})}const we=x("CONNECTED_COMMAND"),Se=x("TOGGLE_CONNECT_COMMAND");function Te(e,t){return new F(t,{trackedOrigins:new Set([e,null])})}function Pe(e,t,n,o,s){e.awareness.setLocalState({anchorPos:null,awarenessData:s,color:n,focusPos:null,focusing:o,name:t})}function Fe(e,t,n,o,s){const{awareness:l}=e;let i=l.getLocalState();null===i&&(i={anchorPos:null,awarenessData:s,color:n,focusPos:null,focusing:o,name:t}),i.focusing=o,l.setLocalState(i)}export{we as CONNECTED_COMMAND,Se as TOGGLE_CONNECT_COMMAND,ie as createBinding,Te as createUndoManager,pe as getAnchorAndFocusCollabNodesForUserState,Pe as initLocalState,Fe as setLocalStateFocus,ke as syncCursorPositions,ve as syncLexicalUpdateToYjs,Ne as syncYjsChangesToLexical};
