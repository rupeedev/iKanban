/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

import{isHTMLElement as t,addClassNamesToElement as e,removeClassNamesFromElement as n,$getAdjacentCaret as r,mergeRegister as i}from"@lexical/utils";import{ElementNode as o,$createParagraphNode as s,$isTextNode as l,$isTabNode as u,$createTabNode as c,$createLineBreakNode as g,$create as a,TextNode as p,$applyNodeReplacement as f,$getSiblingCaret as h,$isLineBreakNode as d,defineExtension as m,$createTextNode as y,$getNodeByKey as x,$getSelection as _,$isRangeSelection as S,$createPoint as v,INDENT_CONTENT_COMMAND as T,OUTDENT_CONTENT_COMMAND as b,INSERT_TAB_COMMAND as C,$setSelectionFromCaretRange as N,$getCaretRangeInDirection as j,$getCaretRange as w,$getTextPointCaret as k,$normalizeCaret as A,KEY_ARROW_UP_COMMAND as P,MOVE_TO_START as L,KEY_TAB_COMMAND as O,COMMAND_PRIORITY_LOW as H,$insertNodes as z,KEY_ARROW_DOWN_COMMAND as E,MOVE_TO_END as B}from"lexical";import"prismjs";import"prismjs/components/prism-clike.js";import"prismjs/components/prism-javascript.js";import"prismjs/components/prism-markup.js";import"prismjs/components/prism-markdown.js";import"prismjs/components/prism-c.js";import"prismjs/components/prism-css.js";import"prismjs/components/prism-objectivec.js";import"prismjs/components/prism-sql.js";import"prismjs/components/prism-powershell.js";import"prismjs/components/prism-python.js";import"prismjs/components/prism-rust.js";import"prismjs/components/prism-swift.js";import"prismjs/components/prism-typescript.js";import"prismjs/components/prism-java.js";import"prismjs/components/prism-cpp.js";function D(t,...e){const n=new URL("https://lexical.dev/docs/error"),r=new URLSearchParams;r.append("code",t);for(const t of e)r.append("v",t);throw n.search=r.toString(),Error(`Minified Lexical error #${t}; visit ${n.toString()} for the full message or use the non-minified dev environment for full errors and additional helpful warnings.`)}const F="javascript",I=()=>F;function M(e,n){for(const r of e.childNodes){if(t(r)&&r.tagName===n)return!0;M(r,n)}return!1}const J="data-language",R="data-highlight-language",K="data-theme";class $ extends o{__language;__theme;__isSyntaxHighlightSupported;static getType(){return"code"}static clone(t){return new $(t.__language,t.__key)}constructor(t,e){super(e),this.__language=t||void 0,this.__isSyntaxHighlightSupported=!1,this.__theme=void 0}afterCloneFrom(t){super.afterCloneFrom(t),this.__language=t.__language,this.__theme=t.__theme,this.__isSyntaxHighlightSupported=t.__isSyntaxHighlightSupported}createDOM(t){const n=document.createElement("code");e(n,t.theme.code),n.setAttribute("spellcheck","false");const r=this.getLanguage();r&&(n.setAttribute(J,r),this.getIsSyntaxHighlightSupported()&&n.setAttribute(R,r));const i=this.getTheme();i&&n.setAttribute(K,i);const o=this.getStyle();return o&&n.setAttribute("style",o),n}updateDOM(t,e,n){const r=this.__language,i=t.__language;r?r!==i&&e.setAttribute(J,r):i&&e.removeAttribute(J);const o=this.__isSyntaxHighlightSupported;t.__isSyntaxHighlightSupported&&i?o&&r?r!==i&&e.setAttribute(R,r):e.removeAttribute(R):o&&r&&e.setAttribute(R,r);const s=this.__theme,l=t.__theme;s?s!==l&&e.setAttribute(K,s):l&&e.removeAttribute(K);const u=this.__style,c=t.__style;return u?u!==c&&e.setAttribute("style",u):c&&e.removeAttribute("style"),!1}exportDOM(t){const n=document.createElement("pre");e(n,t._config.theme.code),n.setAttribute("spellcheck","false");const r=this.getLanguage();r&&(n.setAttribute(J,r),this.getIsSyntaxHighlightSupported()&&n.setAttribute(R,r));const i=this.getTheme();i&&n.setAttribute(K,i);const o=this.getStyle();return o&&n.setAttribute("style",o),{element:n}}static importDOM(){return{code:t=>null!=t.textContent&&(/\r?\n/.test(t.textContent)||M(t,"BR"))?{conversion:U,priority:1}:null,div:()=>({conversion:X,priority:1}),pre:()=>({conversion:U,priority:0}),table:t=>Y(t)?{conversion:Q,priority:3}:null,td:t=>{const e=t,n=e.closest("table");return e.classList.contains("js-file-line")||n&&Y(n)?{conversion:G,priority:3}:null},tr:t=>{const e=t.closest("table");return e&&Y(e)?{conversion:G,priority:3}:null}}}static importJSON(t){return W().updateFromJSON(t)}updateFromJSON(t){return super.updateFromJSON(t).setLanguage(t.language).setTheme(t.theme)}exportJSON(){return{...super.exportJSON(),language:this.getLanguage(),theme:this.getTheme()}}insertNewAfter(t,e=!0){const n=this.getChildren(),r=n.length;if(r>=2&&"\n"===n[r-1].getTextContent()&&"\n"===n[r-2].getTextContent()&&t.isCollapsed()&&t.anchor.key===this.__key&&t.anchor.offset===r){n[r-1].remove(),n[r-2].remove();const t=s();return this.insertAfter(t,e),t}const{anchor:i,focus:o}=t,a=(i.isBefore(o)?i:o).getNode();if(l(a)){let t=it(a);const e=[];for(;;)if(u(t))e.push(c()),t=t.getNextSibling();else{if(!nt(t))break;{let n=0;const r=t.getTextContent(),i=t.getTextContentSize();for(;n<i&&" "===r[n];)n++;if(0!==n&&e.push(et(" ".repeat(n))),n!==i)break;t=t.getNextSibling()}}const n=a.splitText(i.offset)[0],r=0===i.offset?0:1,o=n.getIndexWithinParent()+r,s=a.getParentOrThrow(),l=[g(),...e];s.splice(o,0,l);const p=e[e.length-1];p?p.select():0===i.offset?n.selectPrevious():n.getNextSibling().selectNext(0,0)}if(q(a)){const{offset:e}=t.anchor;a.splice(e,0,[g()]),a.select(e+1,e+1)}return null}canIndent(){return!1}collapseAtStart(){const t=s();return this.getChildren().forEach(e=>t.append(e)),this.replace(t),!0}setLanguage(t){const e=this.getWritable();return e.__language=t||void 0,e}getLanguage(){return this.getLatest().__language}setIsSyntaxHighlightSupported(t){const e=this.getWritable();return e.__isSyntaxHighlightSupported=t,e}getIsSyntaxHighlightSupported(){return this.getLatest().__isSyntaxHighlightSupported}setTheme(t){const e=this.getWritable();return e.__theme=t||void 0,e}getTheme(){return this.getLatest().__theme}}function W(t,e){return a($).setLanguage(t).setTheme(e)}function q(t){return t instanceof $}function U(t){return{node:W(t.getAttribute(J))}}function X(t){const e=t,n=V(e);return n||function(t){let e=t.parentElement;for(;null!==e;){if(V(e))return!0;e=e.parentElement}return!1}(e)?{node:n?W():null}:{node:null}}function Q(){return{node:W()}}function G(){return{node:null}}function V(t){return null!==t.style.fontFamily.match("monospace")}function Y(t){return t.classList.contains("js-file-line-container")}class Z extends p{__highlightType;constructor(t="",e,n){super(t,n),this.__highlightType=e}static getType(){return"code-highlight"}static clone(t){return new Z(t.__text,t.__highlightType||void 0,t.__key)}getHighlightType(){return this.getLatest().__highlightType}setHighlightType(t){const e=this.getWritable();return e.__highlightType=t||void 0,e}canHaveFormat(){return!1}createDOM(t){const n=super.createDOM(t),r=tt(t.theme,this.__highlightType);return e(n,r),n}updateDOM(t,r,i){const o=super.updateDOM(t,r,i),s=tt(i.theme,t.__highlightType),l=tt(i.theme,this.__highlightType);return s!==l&&(s&&n(r,s),l&&e(r,l)),o}static importJSON(t){return et().updateFromJSON(t)}updateFromJSON(t){return super.updateFromJSON(t).setHighlightType(t.highlightType)}exportJSON(){return{...super.exportJSON(),highlightType:this.getHighlightType()}}setFormat(t){return this}isParentRequired(){return!0}createParentElementNode(){return W()}}function tt(t,e){return e&&t&&t.codeHighlight&&t.codeHighlight[e]}function et(t="",e){return f(new Z(t,e))}function nt(t){return t instanceof Z}function rt(t,e){let n=t;for(let i=h(t,e);i&&(nt(i.origin)||u(i.origin));i=r(i))n=i.origin;return n}function it(t){return rt(t,"previous")}function ot(t){return rt(t,"next")}function st(t,e){let n=null,r=null,i=t,o=e,s=t.getTextContent();for(;;){if(0===o){if(i=i.getPreviousSibling(),null===i)break;if(nt(i)||u(i)||d(i)||D(167),d(i)){n={node:i,offset:1};break}o=Math.max(0,i.getTextContentSize()-1),s=i.getTextContent()}else o--;const t=s[o];nt(i)&&" "!==t&&(r={node:i,offset:o})}if(null!==r)return r;let l=null;if(e<t.getTextContentSize())nt(t)&&(l=t.getTextContent()[e]);else{const e=t.getNextSibling();nt(e)&&(l=e.getTextContent()[0])}if(null!==l&&" "!==l)return n;{const r=function(t,e){let n=t,r=e,i=t.getTextContent(),o=t.getTextContentSize();for(;;){if(!nt(n)||r===o){if(n=n.getNextSibling(),null===n||d(n))return null;nt(n)&&(r=0,i=n.getTextContent(),o=n.getTextContentSize())}if(nt(n)){if(" "!==i[r])return{node:n,offset:r};r++}}}(t,e);return null!==r?r:n}}function lt(t){const e=ot(t);return d(e)&&D(168),e}const ut=m({name:"@lexical/code",nodes:[$,Z]});!function(t){t.languages.diff={coord:[/^(?:\*{3}|-{3}|\+{3}).*$/m,/^@@.*@@$/m,/^\d.*$/m]};var e={"deleted-sign":"-","deleted-arrow":"<","inserted-sign":"+","inserted-arrow":">",unchanged:" ",diff:"!"};Object.keys(e).forEach(function(n){var r=e[n],i=[];/^\w+$/.test(n)||i.push(/\w+/.exec(n)[0]),"diff"===n&&i.push("bold"),t.languages.diff[n]={pattern:RegExp("^(?:["+r+"].*(?:\r\n?|\n|(?![\\s\\S])))+","m"),alias:i,inside:{line:{pattern:/(.)(?=[\s\S]).*(?:\r\n?|\n)?/,lookbehind:!0},prefix:{pattern:/[\s\S]/,alias:/\w+/.exec(n)[0]}}}}),Object.defineProperty(t.languages.diff,"PREFIXES",{value:e})}(Prism);const ct=globalThis.Prism||window.Prism,gt={c:"C",clike:"C-like",cpp:"C++",css:"CSS",html:"HTML",java:"Java",js:"JavaScript",markdown:"Markdown",objc:"Objective-C",plain:"Plain Text",powershell:"PowerShell",py:"Python",rust:"Rust",sql:"SQL",swift:"Swift",typescript:"TypeScript",xml:"XML"},at={cpp:"cpp",java:"java",javascript:"js",md:"markdown",plaintext:"plain",python:"py",text:"plain",ts:"typescript"};function pt(t){return at[t]||t}function ft(t){const e=pt(t);return gt[e]||e}const ht=()=>Object.keys(ct.languages).filter(t=>"function"!=typeof ct.languages[t]).sort();function dt(){const t=[];for(const[e,n]of Object.entries(gt))t.push([e,n]);return t}function mt(){return[]}function yt(t){return"string"==typeof t?t:Array.isArray(t)?t.map(yt).join(""):yt(t.content)}function xt(t,e){const n=/^diff-([\w-]+)/i.exec(e),r=t.getTextContent();let i=ct.tokenize(r,ct.languages[n?"diff":e]);return n&&(i=function(t,e){const n=e,r=ct.languages[n],i={tokens:t},o=ct.languages.diff.PREFIXES;for(const t of i.tokens){if("string"==typeof t||!(t.type in o)||!Array.isArray(t.content))continue;const e=t.type;let n=0;const i=()=>(n++,new ct.Token("prefix",o[e],e.replace(/^(\w+).*/,"$1"))),s=t.content.filter(t=>"string"==typeof t||"prefix"!==t.type),l=t.content.length-s.length,u=ct.tokenize(yt(s),r);u.unshift(i());const c=/\r\n|\n/g,g=t=>{const e=[];c.lastIndex=0;let r,o=0;for(;n<l&&(r=c.exec(t));){const n=r.index+r[0].length;e.push(t.slice(o,n)),o=n,e.push(i())}if(0!==e.length)return o<t.length&&e.push(t.slice(o)),e},a=t=>{for(let e=0;e<t.length&&n<l;e++){const n=t[e];if("string"==typeof n){const r=g(n);r&&(t.splice(e,1,...r),e+=r.length-1)}else if("string"==typeof n.content){const t=g(n.content);t&&(n.content=t)}else Array.isArray(n.content)?a(n.content):a([n.content])}};a(u),n<l&&u.push(i()),t.content=u}return i.tokens}(i,n[1])),_t(i)}function _t(t,e){const n=[];for(const r of t)if("string"==typeof r){const t=r.split(/(\n|\t)/),i=t.length;for(let r=0;r<i;r++){const i=t[r];"\n"===i||"\r\n"===i?n.push(g()):"\t"===i?n.push(c()):i.length>0&&n.push(et(i,e))}}else{const{content:t,alias:e}=r;"string"==typeof t?n.push(..._t([t],"prefix"===r.type&&"string"==typeof e?e:r.type)):Array.isArray(t)&&n.push(..._t(t,"unchanged"===r.type?void 0:r.type))}return n}const St={$tokenize(t,e){return xt(t,e||this.defaultLanguage)},defaultLanguage:F,tokenize(t,e){return ct.tokenize(t,ct.languages[e||""]||ct.languages[this.defaultLanguage])}};function vt(t,e,n){const r=t.getParent();q(r)?Ct(r,e,n):nt(t)&&t.replace(y(t.__text))}function Tt(t,e){const n=e.getElementByKey(t.getKey());if(null===n)return;const r=t.getChildren(),i=r.length;if(i===n.__cachedChildrenLength)return;n.__cachedChildrenLength=i;let o="1",s=1;for(let t=0;t<i;t++)d(r[t])&&(o+="\n"+ ++s);n.setAttribute("data-gutter",o)}const bt=new Set;function Ct(t,e,n){const r=t.getKey();void 0===t.getLanguage()&&t.setLanguage(n.defaultLanguage);const i=t.getLanguage()||n.defaultLanguage;if(!function(t){const e=function(t){const e=/^diff-([\w-]+)/i.exec(t);return e?e[1]:null}(t),n=e||t;try{return!!n&&ct.languages.hasOwnProperty(n)}catch(t){return!1}}(i))return t.getIsSyntaxHighlightSupported()&&t.setIsSyntaxHighlightSupported(!1),void async function(){}();t.getIsSyntaxHighlightSupported()||t.setIsSyntaxHighlightSupported(!0),bt.has(r)||(bt.add(r),e.update(()=>{!function(t,e){const n=x(t);if(!q(n)||!n.isAttached())return;const r=_();if(!S(r))return void e();const i=r.anchor,o=i.offset,s="element"===i.type&&d(n.getChildAtIndex(i.offset-1));let u=0;if(!s){const t=i.getNode();u=o+t.getPreviousSiblings().reduce((t,e)=>t+e.getTextContentSize(),0)}if(!e())return;if(s)return void i.getNode().select(o,o);n.getChildren().some(t=>{const e=l(t);if(e||d(t)){const n=t.getTextContentSize();if(e&&n>=u)return t.select(u,u),!0;u-=n}return!1})}(r,()=>{const e=x(r);if(!q(e)||!e.isAttached())return!1;const i=e.getLanguage()||n.defaultLanguage,o=n.$tokenize(e,i),s=function(t,e){let n=0;for(;n<t.length&&Nt(t[n],e[n]);)n++;const r=t.length,i=e.length,o=Math.min(r,i)-n;let s=0;for(;s<o;)if(s++,!Nt(t[r-s],e[i-s])){s--;break}const l=n,u=r-s,c=e.slice(n,i-s);return{from:l,nodesForReplacement:c,to:u}}(e.getChildren(),o),{from:l,to:u,nodesForReplacement:c}=s;return!(l===u&&!c.length)&&(t.splice(l,u-l,c),!0)})},{onUpdate:()=>{bt.delete(r)},skipTransforms:!0}))}function Nt(t,e){return nt(t)&&nt(e)&&t.__text===e.__text&&t.__highlightType===e.__highlightType||u(t)&&u(e)||d(t)&&d(e)}function jt(t){if(!S(t))return!1;const e=t.anchor.getNode(),n=q(e)?e:e.getParent(),r=t.focus.getNode(),i=q(r)?r:r.getParent();return q(n)&&n.is(i)}function wt(t){const e=t.getNodes(),n=[];if(1===e.length&&q(e[0]))return n;let r=[];for(let t=0;t<e.length;t++){const i=e[t];nt(i)||u(i)||d(i)||D(169),d(i)?r.length>0&&(n.push(r),r=[]):r.push(i)}if(r.length>0){const e=t.isBackward()?t.anchor:t.focus,i=v(r[0].getKey(),0,"text");e.is(i)||n.push(r)}return n}function kt(t){const e=_();if(!S(e)||!jt(e))return!1;const n=wt(e),r=n.length;if(0===r&&e.isCollapsed())return t===T&&e.insertNodes([c()]),!0;if(0===r&&t===T&&"\n"===e.getTextContent()){const t=c(),n=g(),r=e.isBackward()?"previous":"next";return e.insertNodes([t,n]),N(j(w(k(t,"next",0),A(h(n,"next"))),r)),!0}for(let i=0;i<r;i++){const r=n[i];if(r.length>0){let n=r[0];if(0===i&&(n=it(n)),t===T){const t=c();if(n.insertBefore(t),0===i){const r=e.isBackward()?"focus":"anchor",i=v(n.getKey(),0,"text");e[r].is(i)&&e[r].set(t.getKey(),0,"text")}}else u(n)&&n.remove()}}return!0}function At(t,e){const n=_();if(!S(n))return!1;const{anchor:r,focus:i}=n,o=r.offset,s=i.offset,l=r.getNode(),c=i.getNode(),g=t===P;if(!jt(n)||!nt(l)&&!u(l)||!nt(c)&&!u(c))return!1;if(!e.altKey){if(n.isCollapsed()){const t=l.getParentOrThrow();if(g&&0===o&&null===l.getPreviousSibling()){if(null===t.getPreviousSibling())return t.selectPrevious(),e.preventDefault(),!0}else if(!g&&o===l.getTextContentSize()&&null===l.getNextSibling()){if(null===t.getNextSibling())return t.selectNext(),e.preventDefault(),!0}}return!1}let a,p;if(l.isBefore(c)?(a=it(l),p=ot(c)):(a=it(c),p=ot(l)),null==a||null==p)return!1;const f=a.getNodesBetween(p);for(let t=0;t<f.length;t++){const e=f[t];if(!nt(e)&&!u(e)&&!d(e))return!1}e.preventDefault(),e.stopPropagation();const h=g?a.getPreviousSibling():p.getNextSibling();if(!d(h))return!0;const m=g?h.getPreviousSibling():h.getNextSibling();if(null==m)return!0;const y=nt(m)||u(m)||d(m)?g?it(m):ot(m):null;let x=null!=y?y:m;return h.remove(),f.forEach(t=>t.remove()),t===P?(f.forEach(t=>x.insertBefore(t)),x.insertBefore(h)):(x.insertAfter(h),x=h,f.forEach(t=>{x.insertAfter(t),x=t})),n.setTextNodeRange(l,o,c,s),!0}function Pt(t,e){const n=_();if(!S(n))return!1;const{anchor:r,focus:i}=n,o=r.getNode(),s=i.getNode(),l=t===L;if(!jt(n)||!nt(o)&&!u(o)||!nt(s)&&!u(s))return!1;if(l){const t=st(s,i.offset);if(null!==t){const{node:e,offset:r}=t;d(e)?e.selectNext(0,0):n.setTextNodeRange(e,r,e,r)}else s.getParentOrThrow().selectStart()}else{lt(s).select()}return e.preventDefault(),e.stopPropagation(),!0}function Lt(t,e){if(!t.hasNodes([$,Z]))throw new Error("CodeHighlightPlugin: CodeNode or CodeHighlightNode not registered on editor");null==e&&(e=St);const n=[];return!0!==t._headless&&n.push(t.registerMutationListener($,e=>{t.update(()=>{for(const[n,r]of e)if("destroyed"!==r){const e=x(n);null!==e&&Tt(e,t)}})},{skipInitialization:!1})),n.push(t.registerNodeTransform($,n=>Ct(n,t,e)),t.registerNodeTransform(p,n=>vt(n,t,e)),t.registerNodeTransform(Z,n=>vt(n,t,e)),t.registerCommand(O,e=>{const n=function(t){const e=_();if(!S(e)||!jt(e))return null;const n=t?b:T,r=t?b:C,i=e.anchor,o=e.focus;if(i.is(o))return r;const s=wt(e);if(1!==s.length)return n;const l=s[0];let u,c;0===l.length&&D(285),e.isBackward()?(u=o,c=i):(u=i,c=o);const g=it(l[0]),a=ot(l[0]),p=v(g.getKey(),0,"text"),f=v(a.getKey(),a.getTextContentSize(),"text");return u.isBefore(p)||f.isBefore(c)?n:p.isBefore(u)||c.isBefore(f)?r:n}(e.shiftKey);return null!==n&&(e.preventDefault(),t.dispatchCommand(n,void 0),!0)},H),t.registerCommand(C,()=>!!jt(_())&&(z([c()]),!0),H),t.registerCommand(T,t=>kt(T),H),t.registerCommand(b,t=>kt(b),H),t.registerCommand(P,t=>{const e=_();if(!S(e))return!1;const{anchor:n}=e,r=n.getNode();return!!jt(e)&&(e.isCollapsed()&&0===n.offset&&null===r.getPreviousSibling()&&q(r.getParentOrThrow())?(t.preventDefault(),!0):At(P,t))},H),t.registerCommand(E,t=>{const e=_();if(!S(e))return!1;const{anchor:n}=e,r=n.getNode();return!!jt(e)&&(e.isCollapsed()&&n.offset===r.getTextContentSize()&&null===r.getNextSibling()&&q(r.getParentOrThrow())?(t.preventDefault(),!0):At(E,t))},H),t.registerCommand(L,t=>Pt(L,t),H),t.registerCommand(B,t=>Pt(B,t),H)),i(...n)}const Ot=it,Ht=ot,zt=lt,Et=st;export{et as $createCodeHighlightNode,W as $createCodeNode,lt as $getEndOfCodeInLine,it as $getFirstCodeNodeOfLine,ot as $getLastCodeNodeOfLine,st as $getStartOfCodeInLine,nt as $isCodeHighlightNode,q as $isCodeNode,gt as CODE_LANGUAGE_FRIENDLY_NAME_MAP,at as CODE_LANGUAGE_MAP,ut as CodeExtension,Z as CodeHighlightNode,$ as CodeNode,F as DEFAULT_CODE_LANGUAGE,St as PrismTokenizer,dt as getCodeLanguageOptions,ht as getCodeLanguages,mt as getCodeThemeOptions,I as getDefaultCodeLanguage,zt as getEndOfCodeInLine,Ot as getFirstCodeNodeOfLine,ft as getLanguageFriendlyName,Ht as getLastCodeNodeOfLine,Et as getStartOfCodeInLine,pt as normalizeCodeLang,pt as normalizeCodeLanguage,Lt as registerCodeHighlighting};
