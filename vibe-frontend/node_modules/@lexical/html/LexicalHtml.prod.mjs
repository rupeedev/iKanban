/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

import{$sliceSelectedTextNodeContent as e}from"@lexical/selection";import{isHTMLElement as n,isBlockDomNode as t}from"@lexical/utils";import{isDOMDocumentNode as o,$getRoot as l,$isElementNode as r,$cloneWithProperties as i,$isTextNode as s,getRegisteredNode as c,isDocumentFragment as u,$isRootOrShadowRoot as f,$isBlockElementNode as a,$createLineBreakNode as d,ArtificialNode__DO_NOT_USE as p,isInlineDomNode as h,$createParagraphNode as m}from"lexical";function g(e,n){const t=o(n)?n.body.childNodes:n.childNodes;let l=[];const r=[];for(const n of t)if(!y.has(n.nodeName)){const t=C(n,e,r,!1);null!==t&&(l=l.concat(t))}return function(e){for(const n of e)n.getNextSibling()instanceof p&&n.insertAfter(d());for(const n of e){const e=n.getChildren();for(const t of e)n.insertBefore(t);n.remove()}}(r),l}function x(e,n){if("undefined"==typeof document||"undefined"==typeof window&&void 0===global.window)throw new Error("To use $generateHtmlFromNodes in headless mode please initialize a headless browser implementation such as JSDom before calling this function.");const t=document.createElement("div"),o=l().getChildren();for(let l=0;l<o.length;l++){w(e,o[l],t,n)}return t.innerHTML}function w(t,o,l,f=null){let a=null===f||o.isSelected(f);const d=r(o)&&o.excludeFromCopy("html");let p=o;if(null!==f){let n=i(o);n=s(n)&&null!==f?e(f,n):n,p=n}const h=r(p)?p.getChildren():[],m=c(t,p.getType());let g;g=m&&void 0!==m.exportDOM?m.exportDOM(t,p):p.exportDOM(t);const{element:x,after:y}=g;if(!x)return!1;const C=document.createDocumentFragment();for(let e=0;e<h.length;e++){const n=h[e],l=w(t,n,C,f);!a&&r(o)&&l&&o.extractWithChild(n,f,"html")&&(a=!0)}if(a&&!d){if((n(x)||u(x))&&x.append(C),l.append(x),y){const e=y.call(p,x);e&&(u(x)?x.replaceChildren(e):x.replaceWith(e))}}else l.append(C);return a}const y=new Set(["STYLE","SCRIPT"]);function C(e,n,o,l,i=new Map,s){let c=[];if(y.has(e.nodeName))return c;let u=null;const g=function(e,n){const{nodeName:t}=e,o=n._htmlConversions.get(t.toLowerCase());let l=null;if(void 0!==o)for(const n of o){const t=n(e);null!==t&&(null===l||(l.priority||0)<=(t.priority||0))&&(l=t)}return null!==l?l.conversion:null}(e,n),x=g?g(e):null;let w=null;if(null!==x){w=x.after;const n=x.node;if(u=Array.isArray(n)?n[n.length-1]:n,null!==u){for(const[,e]of i)if(u=e(u,s),!u)break;u&&c.push(...Array.isArray(n)?n:[u])}null!=x.forChild&&i.set(e.nodeName,x.forChild)}const S=e.childNodes;let v=[];const N=(null==u||!f(u))&&(null!=u&&a(u)||l);for(let e=0;e<S.length;e++)v.push(...C(S[e],n,o,N,new Map(i),u));return null!=w&&(v=w(v)),t(e)&&(v=b(e,v,N?()=>{const e=new p;return o.push(e),e}:m)),null==u?v.length>0?c=c.concat(v):t(e)&&function(e){if(null==e.nextSibling||null==e.previousSibling)return!1;return h(e.nextSibling)&&h(e.previousSibling)}(e)&&(c=c.concat(d())):r(u)&&u.append(...v),c}function b(e,n,t){const o=e.style.textAlign,l=[];let r=[];for(let e=0;e<n.length;e++){const i=n[e];if(a(i))o&&!i.getFormat()&&i.setFormat(o),l.push(i);else if(r.push(i),e===n.length-1||e<n.length-1&&a(n[e+1])){const e=t();e.setFormat(o),e.append(...r),l.push(e),r=[]}}return l}export{x as $generateHtmlFromNodes,g as $generateNodesFromDOM};
