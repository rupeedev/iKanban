name: Gemini Code

# Trigger on @gemini mentions in issues and comments
on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]

# Prevent duplicate runs for the same issue
concurrency:
  group: gemini-issue-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  gemini:
    # Skip if comment is from a bot (prevents Claude/Gemini triggering each other)
    if: |
      (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@gemini')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@gemini')) ||
        (github.event_name == 'issues' && (contains(github.event.issue.body, '@gemini') || contains(github.event.issue.title, '@gemini')))
      ) &&
      (
        github.event_name == 'issues' ||
        (github.event_name != 'issues' && !endsWith(github.event.comment.user.login, '[bot]') && !endsWith(github.event.sender.login, '[bot]'))
      )
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get issue/comment body
        id: get-body
        uses: actions/github-script@v7
        with:
          script: |
            let body = '';
            if (context.eventName === 'issue_comment') {
              body = context.payload.comment.body;
            } else if (context.eventName === 'pull_request_review_comment') {
              body = context.payload.comment.body;
            } else if (context.eventName === 'issues') {
              body = context.payload.issue.body || '';
            }
            return body;
          result-encoding: string

      - name: Run Gemini CLI
        id: gemini
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          # Read the workflow instructions
          INSTRUCTIONS=$(cat .claude/ikanban-fullstack-dev.md 2>/dev/null || echo "Follow standard development practices")
          
          # Get the task from the issue/comment
          TASK="${{ steps.get-body.outputs.result }}"
          
          # Create a prompt file
          cat > /tmp/gemini_prompt.txt << 'EOF'
          IMPORTANT: Before starting any work, read and follow IN ORDER:
          1. .claude/ikanban-fullstack-dev.md - COMPLETE workflow with validation gates
          2. .claude/FILE-MAP.md - Find file paths (DO NOT explore/grep)
          3. .claude/CODING-GUIDELINES.md - Code rules and file size limits

          GITHUB ACTIONS SPECIFIC:
          - You are running in GitHub Actions
          - Run validation gates SEQUENTIALLY
          - Use relative paths from repo root

          WORKFLOW:
          1. Classify task: fix/bug/typo â†’ QUICK, add/implement/new â†’ FEATURE
          2. Create feature branch: git checkout -b <type>/issue-<number>-<desc>
          3. Implement following the ikanban-fullstack-dev workflow
          4. Run validations: pnpm lint, cargo check
          5. Commit and push to feature branch
          6. NEVER merge to main - deployment happens on PR merge

          Now proceed with this task:
          EOF
          echo "$TASK" >> /tmp/gemini_prompt.txt
          
          # Run Gemini CLI
          npx -y @google/gemini-cli@latest --prompt "$(cat /tmp/gemini_prompt.txt)" || echo "Gemini execution completed"

      - name: Comment result on issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ðŸ¤– **Gemini Code** has processed this task.\n\nCheck the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`
            });
