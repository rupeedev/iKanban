name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

env:
  IKANBAN_API_URL: https://api.scho1ar.com/api

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          additional_permissions: "Bash(git:*),Bash(gh:*),Bash(cargo:*),Bash(pnpm:*),Bash(npm:*),Bash(cd:*),Bash(ls:*),Bash(cat:*),Bash(grep:*),Bash(find:*),Bash(head:*),Bash(tail:*),Bash(mkdir:*),Bash(touch:*),Bash(echo:*),Write(*),Edit(*),Read(*),Glob(*),Grep(*)"
          prompt: |
            You are an autonomous GitHub Actions agent for the iKanban project.

            ## MANDATORY: READ CONTEXT FILES FIRST

            Before ANY work, read these files IN ORDER:
            1. .claude/github-fullstack-dev.md - GitHub-specific workflow (CRITICAL)
            2. .claude/FILE-MAP.md - Find file paths (DO NOT explore/grep)
            3. .claude/CODING-GUIDELINES.md - Code rules and file size limits
            4. .claude/CODEBASE-GAPS.md - Known issues and correct API patterns

            ## TASK CONTEXT

            Issue Number: #${{ github.event.issue.number }}
            Issue Title: ${{ github.event.issue.title }}
            Issue Body: See the issue for full description

            ## GITHUB ACTIONS CONSTRAINTS

            - You are SINGLE-AGENT mode (no Task() subagents available)
            - No MCP available - skip MCP task management steps
            - Run validation gates SEQUENTIALLY (not parallel)
            - Use relative paths from repo root (no absolute paths)
            - IKANBAN_API_URL: ${{ env.IKANBAN_API_URL }}
            - IKANBAN_API_TOKEN: ${{ secrets.VIBE_API_TOKEN }}

            ## MANDATORY WORKFLOW (Follow EXACTLY in this order)

            ### Phase 1: Understand the Task
            1. Read the issue title and body to understand what needs to be done
            2. Classify: fix/bug/typo = QUICK, add/implement/new = FEATURE
            3. Extract any metadata from issue body (look for <!-- ikanban-metadata -->)

            ### Phase 2: Create Branch + DRAFT PR (for visibility)
            ```bash
            # Create feature branch
            BRANCH_NAME="<type>/issue-${{ github.event.issue.number }}-<short-desc>"
            git checkout -b $BRANCH_NAME

            # Create an empty commit to enable PR creation
            git commit --allow-empty -m "chore: initialize branch for issue #${{ github.event.issue.number }}"
            git push -u origin $BRANCH_NAME

            # Create DRAFT PR immediately so user can track progress
            PR_URL=$(gh pr create --draft --title "[WIP] <type>: <description>" --body "## Work in Progress

            This PR is being worked on by Claude Code Action.

            **Issue:** #${{ github.event.issue.number }}
            **Status:** In Progress

            ---
            _This PR was created as a draft to provide visibility into the work being done._")

            # Comment on issue that work has started
            gh issue comment ${{ github.event.issue.number }} --body "**Work Started**

            I've created a draft PR to track progress: $PR_URL

            **Current status:** Reading context files and analyzing the issue...

            I'll update this PR as I make progress."
            ```

            ### Phase 3: Implement the Fix/Feature
            1. Read the relevant files identified from FILE-MAP.md
            2. Make the necessary code changes
            3. Follow CODING-GUIDELINES.md strictly
            4. Commit and push changes frequently so user can see progress:
            ```bash
            git add .
            git commit -m "<type>(scope): <description>"
            git push
            ```

            ### Phase 4: Validate (SEQUENTIAL)
            Run these commands in order:
            ```bash
            # Frontend validation
            cd vibe-frontend && pnpm install && pnpm lint && pnpm check

            # Backend validation (if backend changes)
            cd vibe-backend && cargo check --workspace && cargo clippy --workspace -- -D warnings
            ```

            ### Phase 5: Mark PR as Ready
            ```bash
            # Final commit with co-author
            git add .
            git commit -m "<type>(IKA-XXX): <final description>

            Co-Authored-By: Claude <noreply@anthropic.com>"
            git push

            # Update PR title and body with final summary
            gh pr edit --title "<type>: <description>" --body "## Summary
            <what was done>

            ## Changes
            - <change 1>
            - <change 2>

            ## Validation
            - [x] pnpm lint passed
            - [x] pnpm check passed
            - [x] cargo check passed (if applicable)

            Fixes #${{ github.event.issue.number }}

            ---
            Generated by Claude Code Action"

            # Mark PR as ready for review (removes draft status)
            gh pr ready

            # Comment on issue that implementation is complete
            gh issue comment ${{ github.event.issue.number }} --body "**Implementation Complete**

            The PR is now ready for merge.

            **Changes made:**
            - <summary of changes>

            Merging automatically..."
            ```

            ### Phase 6: Merge and Close
            ```bash
            # Merge the PR
            gh pr merge --squash --delete-branch

            # Comment on issue that merge is complete
            gh issue comment ${{ github.event.issue.number }} --body "**Merged to main**

            The fix has been merged and will be deployed automatically.

            **Summary:**
            - <what was fixed/implemented>

            Closing this issue."

            # Close the issue
            gh issue close ${{ github.event.issue.number }}
            ```

            ## CRITICAL REQUIREMENTS

            1. **ALWAYS create DRAFT PR first (Phase 2)** - Gives user visibility into progress
            2. **Push commits as you work (Phase 3)** - User can see progress in the PR
            3. **Comment on issue at each major phase** - Keep user informed
            4. **Mark PR ready before merge (Phase 5)** - Remove draft status
            5. **ALWAYS close the issue after merge (Phase 6)**
            6. If ANY step fails, comment on the issue with the error:
               ```bash
               gh issue comment ${{ github.event.issue.number }} --body "**Failed**

               Error: <error description>

               Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details."
               ```

            ## WORKFLOW SUMMARY

            ```
            Phase 1: Understand Task
                |
            Phase 2: Create Branch + DRAFT PR + Comment "Work Started"
                |
            Phase 3: Implement (push commits as you go)
                |
            Phase 4: Validate (lint, check, clippy)
                |
            Phase 5: Mark PR Ready + Comment "Implementation Complete"
                |
            Phase 6: Merge + Comment "Merged" + Close Issue
            ```

            ## BEGIN EXECUTION

            Now proceed with the task. Start by reading the context files, then follow the workflow phases above.

      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue?.number || context.payload.issue?.number;
            if (issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: '**Claude Code Action failed**\n\nPlease check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
              });
            }
