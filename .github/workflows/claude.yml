name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

env:
  IKANBAN_API_URL: https://api.scho1ar.com/api

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --allowedTools "Bash,Read,Write,Edit,Glob,Grep,WebFetch,WebSearch,Task,TodoWrite"
          prompt: |
            IMPORTANT: Before starting any work, read and follow IN ORDER:
            1. .claude/ikanban-fullstack-dev.md - COMPLETE workflow with validation gates
            2. .claude/FILE-MAP.md - Find file paths (DO NOT explore/grep)
            3. .claude/CODING-GUIDELINES.md - Code rules and file size limits
            4. .claude/PATTERNS.md - Code patterns (if implementing features)

            GITHUB ACTIONS SPECIFIC:
            - You are single-agent (no Task() subagents)
            - No MCP available - skip task management steps
            - Run validation gates SEQUENTIALLY (not parallel)
            - Use relative paths from repo root
            - IKANBAN_API_URL is available: ${{ env.IKANBAN_API_URL }}
            - IKANBAN_API_TOKEN is available: ${{ secrets.VIBE_API_TOKEN }}

            WORKFLOW:
            1. Classify task: fix/bug/typo → QUICK, add/implement/new → FEATURE
            2. Extract task_id and assignment_id from issue body (look for <!-- ikanban-metadata -->)
            3. Create feature branch: git checkout -b <type>/issue-${{ github.event.issue.number }}-<desc>
            4. Implement following the ikanban-fullstack-dev workflow
            5. Run validations: pnpm lint, cargo check, cargo clippy
            6. Commit and push to feature branch
            7. Create PR: gh pr create --title "<type>: <desc>" --body "Fixes #${{ github.event.issue.number }}"
            8. Register PR with iKanban (if task_id and assignment_id found):
               curl -X POST "${{ env.IKANBAN_API_URL }}/tasks/{task_id}/assignments/{assignment_id}/pr" \
                 -H "Authorization: Bearer ${{ secrets.VIBE_API_TOKEN }}" \
                 -H "Content-Type: application/json" \
                 -d '{"pr_number": <pr_number>, "pr_url": "<pr_url>"}'
            9. MERGE the PR: gh pr merge --auto --squash --delete-branch
            10. Deployment will trigger automatically on main

            IMPORTANT:
            - You are autonomous - merge your own PR after validation passes
            - Use --auto flag so merge happens when checks pass
            - The system will callback to iKanban when merge completes
            - If you fail, comment on the issue with the error

            ON FAILURE:
            If implementation fails, add a comment to the issue:
            gh issue comment ${{ github.event.issue.number }} --body "❌ Claude failed to implement: <error reason>"

            Now proceed with the task from the issue/comment.

      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue?.number || context.payload.issue?.number;
            if (issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: '❌ **Claude Code Action failed**\n\nPlease check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
              });
            }
