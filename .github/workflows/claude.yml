name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --allowedTools "Bash,Read,Write,Edit,Glob,Grep,WebFetch,WebSearch,Task,TodoWrite"
          prompt: |
            IMPORTANT: Before starting any work, read and follow IN ORDER:
            1. .claude/ikanban-fullstack-dev.md - COMPLETE workflow with validation gates
            2. .claude/FILE-MAP.md - Find file paths (DO NOT explore/grep)
            3. .claude/CODING-GUIDELINES.md - Code rules and file size limits
            4. .claude/PATTERNS.md - Code patterns (if implementing features)

            GITHUB ACTIONS SPECIFIC:
            - You are single-agent (no Task() subagents)
            - No MCP available - skip task management steps
            - Run validation gates SEQUENTIALLY (not parallel)
            - Use relative paths from repo root

            WORKFLOW:
            1. Classify task: fix/bug/typo → QUICK, add/implement/new → FEATURE
            2. Create feature branch: git checkout -b <type>/issue-<number>-<desc>
            3. Implement following the ikanban-fullstack-dev workflow
            4. Run validations: pnpm lint, cargo check, cargo clippy
            5. Commit and push to feature branch
            6. Create PR: gh pr create --title "<type>: <desc>" --body "Fixes #<issue-number>"
            7. MERGE the PR: gh pr merge --auto --squash
            8. Deployment will trigger automatically on main

            IMPORTANT:
            - You are autonomous - merge your own PR after validation passes
            - Use --auto flag so merge happens when checks pass
            - The system will callback to iKanban when merge completes

            Now proceed with the task from the issue/comment.
