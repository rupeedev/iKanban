name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

# Prevent duplicate runs for the same issue
# Only one workflow runs per issue at a time
concurrency:
  group: claude-issue-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false

env:
  IKANBAN_API_URL: https://api.scho1ar.com/api

jobs:
  # Check if work is already in progress for this issue
  check-existing-pr:
    # Skip if comment is from a bot (prevents Claude/Gemini triggering each other)
    if: |
      (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
        (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
      ) &&
      (
        github.event_name == 'issues' ||
        (github.event_name != 'issues' && !endsWith(github.event.comment.user.login, '[bot]') && !endsWith(github.event.sender.login, '[bot]'))
      )
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.check.outputs.should_skip }}
      pr_url: ${{ steps.check.outputs.pr_url }}
    steps:
      - name: Check for existing PR
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue?.number || context.payload.issue?.number;
            if (!issueNumber) {
              core.setOutput('should_skip', 'false');
              return;
            }

            // Search for open PRs that reference this issue
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            // Check if any PR references this issue
            const linkedPR = prs.find(pr => {
              const body = pr.body || '';
              return body.includes(`#${issueNumber}`) ||
                     body.includes(`issues/${issueNumber}`) ||
                     pr.head.ref.includes(`issue-${issueNumber}`);
            });

            if (linkedPR) {
              console.log(`Found existing PR #${linkedPR.number} for issue #${issueNumber}`);
              core.setOutput('should_skip', 'true');
              core.setOutput('pr_url', linkedPR.html_url);

              // Comment on issue that we're skipping
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `⏭️ **Skipping duplicate run**\n\nWork is already in progress for this issue.\n\n**Existing PR:** ${linkedPR.html_url}\n\nPlease review the existing PR or close it if you want to start fresh.`
              });
            } else {
              console.log(`No existing PR found for issue #${issueNumber}`);
              core.setOutput('should_skip', 'false');
            }

  claude:
    needs: check-existing-pr
    if: needs.check-existing-pr.outputs.should_skip != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          claude_args: "--allowedTools 'Bash(git:*),Bash(gh:*),Bash(cargo:*),Bash(pnpm:*),Bash(npm:*),Bash(cd:*),Bash(ls:*),Bash(mkdir:*),Bash(touch:*),Bash(echo:*),Write,Edit,Read,Glob,Grep'"
          prompt: |
            You are an autonomous GitHub Actions agent for the iKanban project.

            ## MANDATORY: READ CONTEXT FILES FIRST

            Before ANY work, read these files IN ORDER:
            1. .claude/github-fullstack-dev.md - GitHub-specific workflow (CRITICAL)
            2. .claude/FILE-MAP.md - Find file paths (DO NOT explore/grep)
            3. .claude/CODING-GUIDELINES.md - Code rules and file size limits
            4. .claude/CODEBASE-GAPS.md - Known issues and correct API patterns

            ## TASK CONTEXT

            Issue Number: #${{ github.event.issue.number }}
            Issue Title: ${{ github.event.issue.title }}
            Issue Body: See the issue for full description

            ## GITHUB ACTIONS CONSTRAINTS

            - You are SINGLE-AGENT mode (no Task() subagents available)
            - No MCP available - skip MCP task management steps
            - Run validation gates SEQUENTIALLY (not parallel)
            - Use relative paths from repo root (no absolute paths)
            - IKANBAN_API_URL: ${{ env.IKANBAN_API_URL }}
            - IKANBAN_API_TOKEN: ${{ secrets.VIBE_API_TOKEN }}

            ## MANDATORY WORKFLOW (Follow EXACTLY in this order)

            ### Phase 1: Understand the Task
            1. Read the issue title and body to understand what needs to be done
            2. Classify: fix/bug/typo = QUICK, add/implement/new = FEATURE
            3. Extract iKanban metadata from issue body (if present):
               ```bash
               # Look for ikanban-metadata block in issue body (handles multiline format)
               # Format: <!-- ikanban-metadata\ntask_id: UUID\nteam_id: UUID\nassignment_id: UUID\n-->
               ISSUE_BODY=$(gh issue view ${{ github.event.issue.number }} --json body -q .body)
               TASK_ID=$(echo "$ISSUE_BODY" | grep -oP 'task_id:\s*[a-f0-9-]+' | head -1 | sed 's/task_id:\s*//')
               TEAM_ID=$(echo "$ISSUE_BODY" | grep -oP 'team_id:\s*[a-f0-9-]+' | head -1 | sed 's/team_id:\s*//')

               # Fallback to IKA team if team_id not in metadata (for backward compatibility)
               if [ -z "$TEAM_ID" ]; then
                 TEAM_ID="a263e43f-43d3-4af7-a947-5f70e6670921"  # IKA team
               fi

               if [ -n "$TASK_ID" ]; then
                 echo "Found iKanban task: $TASK_ID (team: $TEAM_ID)"
                 export TASK_ID TEAM_ID
               else
                 echo "No iKanban metadata found - skipping task sync"
               fi
               ```

            ### Phase 2: Create Branch + DRAFT PR (for visibility)

            **CRITICAL: Branch Naming Convention**
            - If task is QUICK (fix/bug/typo/update/tweak) → `fix/issue-XX-short-desc`
            - If task is FEATURE (add/implement/create/build/new/docs) → `feature/issue-XX-short-desc`
            - NEVER use other prefixes like `docs/`, `chore/`, `feat/` - ONLY `fix/` or `feature/`

            ```bash
            # Determine branch type based on task classification from Phase 1
            # QUICK tasks (fix/bug/typo) → fix/
            # FEATURE tasks (add/implement/create/new/docs) → feature/
            BRANCH_TYPE="feature"  # Default to feature
            # If issue title/body contains fix/bug/typo keywords, use fix/

            # Create feature branch with CORRECT naming (fix/ or feature/ ONLY)
            BRANCH_NAME="${BRANCH_TYPE}/issue-${{ github.event.issue.number }}-<short-desc>"
            git checkout -b $BRANCH_NAME

            # Create an empty commit to enable PR creation
            git commit --allow-empty -m "chore: initialize branch for issue #${{ github.event.issue.number }}"
            git push -u origin $BRANCH_NAME

            # Create DRAFT PR immediately so user can track progress
            # PR title format: <commit-type>: <description> (commit-type can be fix/feat/docs/chore)
            PR_URL=$(gh pr create --draft --title "[WIP] <commit-type>: <description>" --body "## Work in Progress

            This PR is being worked on by Claude Code Action.

            **Issue:** #${{ github.event.issue.number }}
            **Status:** In Progress

            ---
            _This PR was created as a draft to provide visibility into the work being done._")

            # Comment on issue that work has started
            gh issue comment ${{ github.event.issue.number }} --body "**Work Started**

            I've created a draft PR to track progress: $PR_URL

            **Current status:** Reading context files and analyzing the issue...

            I'll update this PR as I make progress."

            # Update iKanban task to "inprogress" (if task_id found in Phase 1)
            if [ -n "$TASK_ID" ]; then
              curl -s -X PATCH "${{ env.IKANBAN_API_URL }}/teams/$TEAM_ID/issues/$TASK_ID" \
                -H "Authorization: Bearer ${{ secrets.VIBE_API_TOKEN }}" \
                -H "Content-Type: application/json" \
                -d '{"status": "inprogress"}' || echo "Warning: Failed to update iKanban task status"
              echo "Updated iKanban task $TASK_ID to inprogress"
            fi
            ```

            ### Phase 3: Implement the Fix/Feature
            1. Read the relevant files identified from FILE-MAP.md
            2. Make the necessary code changes
            3. Follow CODING-GUIDELINES.md strictly
            4. Commit and push changes frequently so user can see progress:
            ```bash
            git add .
            # Commit message uses conventional commit type (fix/feat/docs/chore/refactor)
            # This is DIFFERENT from branch prefix which is ONLY fix/ or feature/
            git commit -m "<commit-type>(scope): <description>"
            git push
            ```

            ### Phase 4: Validate (SEQUENTIAL)
            Run these commands in order:
            ```bash
            # Frontend validation
            cd vibe-frontend && pnpm install && pnpm lint && pnpm check

            # Backend validation (if backend changes)
            cd vibe-backend && cargo check --workspace && cargo clippy --workspace -- -D warnings
            ```

            ### Phase 5: Mark PR as Ready
            ```bash
            # Final commit with co-author
            git add .
            git commit -m "<type>(IKA-XXX): <final description>

            Co-Authored-By: Claude <noreply@anthropic.com>"
            git push

            # Update PR title and body with final summary
            gh pr edit --title "<type>: <description>" --body "## Summary
            <what was done>

            ## Changes
            - <change 1>
            - <change 2>

            ## Validation
            - [x] pnpm lint passed
            - [x] pnpm check passed
            - [x] cargo check passed (if applicable)

            Fixes #${{ github.event.issue.number }}

            ---
            Generated by Claude Code Action"

            # Mark PR as ready for review (removes draft status)
            gh pr ready

            # Comment on issue that implementation is complete
            gh issue comment ${{ github.event.issue.number }} --body "**Implementation Complete**

            The PR is now ready for merge.

            **Changes made:**
            - <summary of changes>

            Merging automatically..."
            ```

            ### Phase 6: Merge and Close
            ```bash
            # Merge the PR
            gh pr merge --squash --delete-branch

            # Update iKanban task to "done" (if task_id found in Phase 1)
            if [ -n "$TASK_ID" ]; then
              curl -s -X PATCH "${{ env.IKANBAN_API_URL }}/teams/$TEAM_ID/issues/$TASK_ID" \
                -H "Authorization: Bearer ${{ secrets.VIBE_API_TOKEN }}" \
                -H "Content-Type: application/json" \
                -d '{"status": "done"}' || echo "Warning: Failed to update iKanban task status"
              echo "Updated iKanban task $TASK_ID to done"
            fi

            # Comment on issue that merge is complete
            gh issue comment ${{ github.event.issue.number }} --body "**Merged to main**

            The fix has been merged and will be deployed automatically.

            **Summary:**
            - <what was fixed/implemented>

            Closing this issue."

            # Close the issue
            gh issue close ${{ github.event.issue.number }}
            ```

            ## CRITICAL REQUIREMENTS

            1. **ALWAYS create DRAFT PR first (Phase 2)** - Gives user visibility into progress
            2. **Push commits as you work (Phase 3)** - User can see progress in the PR
            3. **Comment on issue at each major phase** - Keep user informed
            4. **Mark PR ready before merge (Phase 5)** - Remove draft status
            5. **ALWAYS close the issue after merge (Phase 6)**
            6. If ANY step fails, comment on the issue with the error:
               ```bash
               gh issue comment ${{ github.event.issue.number }} --body "**Failed**

               Error: <error description>

               Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details."
               ```

            ## WORKFLOW SUMMARY

            ```
            Phase 1: Understand Task + Extract iKanban task_id (if present)
                |
            Phase 2: Create Branch + DRAFT PR + Comment "Work Started" + Update task→inprogress
                |
            Phase 3: Implement (push commits as you go)
                |
            Phase 4: Validate (lint, check, clippy)
                |
            Phase 5: Mark PR Ready + Comment "Implementation Complete"
                |
            Phase 6: Merge + Update task→done + Comment "Merged" + Close Issue
            ```

            ## iKANBAN TASK SYNC (Automatic)

            If the issue body contains metadata in this format:
            ```
            <!-- ikanban-metadata
            task_id: UUID-HERE
            team_id: UUID-HERE
            assignment_id: UUID-HERE
            -->
            ```

            The workflow will automatically:
            - Phase 2: Update task status to "inprogress"
            - Phase 6: Update task status to "done"

            **Note:** If team_id is not present, falls back to IKA team (a263e43f-43d3-4af7-a947-5f70e6670921).

            If no metadata is found, sync is skipped (workflow continues normally).

            ## BEGIN EXECUTION

            Now proceed with the task. Start by reading the context files, then follow the workflow phases above.

      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue?.number || context.payload.issue?.number;
            if (issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: '**Claude Code Action failed**\n\nPlease check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
              });
            }
